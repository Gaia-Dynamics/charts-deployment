{{- if eq "deployment" (default "deployment" $.Values.type) }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $.Values.name }}
  labels:
    app: {{ $.Values.name }}
    env: {{ $.Values.environment }}
spec:
  revisionHistoryLimit: 3
  {{- if ($.Values.suspended)}}
  replicas: 0
  {{- end }}
  selector:
    matchLabels:
      app: {{ $.Values.name }}
      env: {{ $.Values.environment }}
  template:
    metadata:
      labels:
        app: {{ $.Values.name }}
        env: {{ $.Values.environment }}
      {{- if $.Values.linkerd }}
      {{- if $.Values.linkerd.enabled }}
      annotations:
        linkerd.io/inject: enabled
      {{- end }}
      {{- end }}
    spec:
      serviceAccountName: {{ $.Values.name }}
      {{- /* Legacy support for direct scheduling configuration */ -}}
      {{- if $.Values.tolerations }}
      tolerations:
{{ toYaml $.Values.tolerations | indent 8 }}
      {{- end }}
      {{- if $.Values.nodeSelector }}
      nodeSelector:
{{ toYaml $.Values.nodeSelector | indent 8 }}
      {{- end }}
      {{- if $.Values.nodeAffinity }}
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: {{ $.Values.nodeAffinity.key }}
                operator: In
                values:
                - {{ $.Values.nodeAffinity.value }}
      {{- end }}
      {{- /* New workload profile abstraction */ -}}
      {{- if and $.Values.workload (not $.Values.tolerations) (not $.Values.nodeAffinity) }}
      {{- if eq $.Values.workload.profile "compute-intensive" }}
      tolerations:
        - key: "workload-type"
          operator: "Equal"
          value: "compute-intensive"
          effect: "NoSchedule"
      {{- if $.Values.workload.size }}
      {{- if or (eq $.Values.workload.size "large") (eq $.Values.workload.size "xlarge") }}
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: tier
                operator: In
                values:
                - large
      {{- end }}
      {{- end }}
      {{- else if eq $.Values.workload.profile "memory-intensive" }}
      tolerations:
        - key: "workload-type"
          operator: "Equal"
          value: "memory-intensive"
          effect: "NoSchedule"
      {{- if $.Values.workload.size }}
      {{- if or (eq $.Values.workload.size "large") (eq $.Values.workload.size "xlarge") }}
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: tier
                operator: In
                values:
                - large
      {{- end }}
      {{- end }}
      {{- else if eq $.Values.workload.profile "standard" }}
      {{- if $.Values.workload.size }}
      {{- if or (eq $.Values.workload.size "large") (eq $.Values.workload.size "xlarge") }}
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: tier
                operator: In
                values:
                - large
      {{- end }}
      {{- end }}
      {{- end }}
      {{- end }}
      terminationGracePeriodSeconds: 80
      {{- if $.Values.image }}
      containers:
      - name: {{ $.Values.name }}
        image: "{{ $.Values.image.registry }}/{{ $.Values.image.name }}:{{ $.Values.image.tag }}"
        imagePullPolicy: {{ $.Values.image.pullPolicy }}
        {{- if $.Values.image.command }}
        {{- if kindIs "string" $.Values.image.command }}
        command: [{{ $.Values.image.command | quote }}]
        {{- else }}
        command:
        {{- range $.Values.image.command }}
        - {{ . | quote }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- if $.Values.image.args }}
        args:
        {{- range $.Values.image.args }}
        - {{ . | quote }}
        {{- end }}
        {{- end }}
        {{- if $.Values.service -}}
        {{ $length := len $.Values.service.ports }} {{ if gt $length 0 }}
        ports:
          {{- range $value := $.Values.service.ports }}
          - name: {{ printf "port-%s-tcp" $value }}
            containerPort: {{ $value }}
            protocol: TCP
          {{- end }}
        {{- end }}
        {{- end }}
        envFrom:
          {{- if $.Values.env }}
          {{- if $.Values.env.public }}
          - configMapRef:
              name: {{ $.Values.name }}
          {{- end }}
          {{- if $.Values.env.secrets }}
          {{- range $index, $secret := $.Values.env.secrets }}
          - secretRef:
              name: {{ $.Values.name }}-{{ $index }}
          {{- end }}
          {{- end }}
          {{- end }}
        {{- if $.Values.livenessProbe }}
        {{- if $.Values.livenessProbe.enabled }}
        livenessProbe:
          httpGet:
            path: {{ $.Values.livenessProbe.httpPath | default "/" }}
            port: {{ $.Values.livenessProbe.httpPort | default "80" }}
          initialDelaySeconds: {{ $.Values.livenessProbe.initialDelaySeconds | default 30 }}
          periodSeconds: {{ $.Values.livenessProbe.periodSeconds | default 10 }}
          successThreshold: {{ $.Values.livenessProbe.successThreshold | default 1 }}
          timeoutSeconds: {{ $.Values.livenessProbe.timeoutSeconds | default 3 }}
          failureThreshold: {{ $.Values.livenessProbe.failureThreshold | default 3 }}
        {{- end }}
        {{- end }}
        {{- if $.Values.readinessProbe }}
        {{- if $.Values.readinessProbe.enabled }}
        readinessProbe:
          httpGet:
            path: {{ $.Values.readinessProbe.httpPath | default "/" }}
            port: {{ $.Values.readinessProbe.httpPort | default "80" }}
          initialDelaySeconds: {{ $.Values.readinessProbe.initialDelaySeconds | default 30 }}
          periodSeconds: {{ $.Values.readinessProbe.periodSeconds | default 10 }}
          successThreshold: {{ $.Values.readinessProbe.successThreshold | default 1 }}
          timeoutSeconds: {{ $.Values.readinessProbe.timeoutSeconds | default 3 }}
          failureThreshold: {{ $.Values.readinessProbe.failureThreshold | default 3 }}
        {{- end }}
        {{- end }}
        {{- if $.Values.resources }}
        resources:
{{ toYaml $.Values.resources | indent 10 }}
        {{- end }}
        {{- if $.Values.configMaps }}
        volumeMounts:
        {{- range $configMap := $.Values.configMaps }}
        - name: {{ $configMap.name }}
          mountPath: {{ $configMap.mountPath }}
          {{- if $configMap.subPath }}
          subPath: {{ $configMap.subPath }}
          {{- end }}
          {{- if $configMap.readOnly }}
          readOnly: {{ $configMap.readOnly }}
          {{- end }}
        {{- end }}
        {{- end }}
      {{- end }}
      {{- if $.Values.configMaps }}
      volumes:
      {{- range $configMap := $.Values.configMaps }}
      - name: {{ $configMap.name }}
        configMap:
          name: {{ $.Values.name }}-{{ $configMap.name }}
          {{- if $configMap.defaultMode }}
          defaultMode: {{ $configMap.defaultMode }}
          {{- end }}
      {{- end }}
      {{- end }}
{{- end }}

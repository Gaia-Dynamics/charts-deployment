{{- if and .Values.sqs .Values.sqs.queues }}
{{- range .Values.sqs.queues }}
---
# SQS Queue (Upbound Provider)
apiVersion: sqs.aws.upbound.io/v1beta1
kind: Queue
metadata:
  name: {{ .name }}
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
spec:
  deletionPolicy: {{ .deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    region: {{ $.Values.global.region }}
    name: {{ .name }}

    {{- if .fifo }}
    fifoQueue: true
    {{- if .contentBasedDeduplication }}
    contentBasedDeduplication: {{ .contentBasedDeduplication }}
    {{- end }}
    {{- end }}

    {{- if .visibilityTimeout }}
    visibilityTimeoutSeconds: {{ .visibilityTimeout }}
    {{- end }}

    {{- if .messageRetentionPeriod }}
    messageRetentionSeconds: {{ .messageRetentionPeriod }}
    {{- end }}

    {{- if .maximumMessageSize }}
    maxMessageSize: {{ .maximumMessageSize }}
    {{- end }}

    {{- if .delaySeconds }}
    delaySeconds: {{ .delaySeconds }}
    {{- end }}

    {{- if .receiveMessageWaitTimeSeconds }}
    receiveWaitTimeSeconds: {{ .receiveMessageWaitTimeSeconds }}
    {{- end }}

    {{- if .redrivePolicy }}
    redrivePolicy: |
      {
        {{- if .redrivePolicy.deadLetterTargetArn }}
        "deadLetterTargetArn": {{ .redrivePolicy.deadLetterTargetArn | quote }},
        {{- else if .redrivePolicy.deadLetterQueueName }}
        "deadLetterTargetArn": "arn:aws:sqs:{{ $.Values.global.region }}:{{ $.Values.global.accountId }}:{{ .redrivePolicy.deadLetterQueueName }}",
        {{- else }}
        {{- fail "redrivePolicy requires either deadLetterTargetArn or deadLetterQueueName with global.region and global.accountId" }}
        {{- end }}
        "maxReceiveCount": {{ .redrivePolicy.maxReceiveCount | default 3 }}
      }
    {{- end }}

    {{- if .kmsMasterKeyId }}
    kmsMasterKeyId: {{ .kmsMasterKeyId }}
    {{- end }}

    {{- if .kmsDataKeyReusePeriodSeconds }}
    kmsDataKeyReusePeriodSeconds: {{ .kmsDataKeyReusePeriodSeconds }}
    {{- end }}

    {{- if .sseEnabled }}
    sqsManagedSseEnabled: {{ .sseEnabled }}
    {{- end }}

    {{- if .policy }}
    policy: |
      {{ .policy | nindent 6 }}
    {{- end }}

    tags:
      Name: {{ .name }}
      Environment: {{ $.Values.global.environment }}
      ManagedBy: {{ $.Values.global.tags.managedBy | default "crossplane" }}
      Department: {{ $.Values.global.tags.department | default "engineering" }}
      Service: {{ $.Values.global.tags.service | default "gaia" }}
      {{- range $key, $value := .tags }}
      {{ $key }}: {{ $value | quote }}
      {{- end }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}

{{- if .createPolicy }}
---
# IAM Policy for SQS Queue Access
apiVersion: iam.aws.upbound.io/v1beta1
kind: Policy
metadata:
  name: {{ .name }}-policy
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
spec:
  deletionPolicy: {{ .deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    name: {{ .name }}-policy
    description: {{ printf "Policy for SQS queue %s managed by Crossplane" .name }}
    policy: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "QueueAccess",
            "Effect": "Allow",
            "Action": [
              "sqs:DeleteMessage",
              "sqs:GetQueueAttributes",
              "sqs:GetQueueUrl",
              "sqs:ReceiveMessage",
              "sqs:SendMessage",
              "sqs:ChangeMessageVisibility",
              "sqs:PurgeQueue"
            ],
            "Resource": "arn:aws:sqs:{{ $.Values.global.region }}:{{ $.Values.global.accountId }}:{{ .name }}"
          }
          {{- if .kmsMasterKeyId }},
          {
            "Sid": "KMSAccess",
            "Effect": "Allow",
            "Action": [
              "kms:Decrypt",
              "kms:GenerateDataKey"
            ],
            "Resource": "{{ .kmsMasterKeyId }}"
          }
          {{- end }}
        ]
      }
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}
{{- end }}

{{- if and .createPolicy .attachToRoles }}
{{- $queue := . }}
{{- range $index, $role := .attachToRoles }}
---
# IAM Role Policy Attachment
apiVersion: iam.aws.upbound.io/v1beta1
kind: RolePolicyAttachment
metadata:
  name: {{ $queue.name }}-role-attachment-{{ $index }}
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ $queue.name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
    purpose: irsa-attachment
spec:
  deletionPolicy: {{ $queue.deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    policyArnSelector:
      matchLabels:
        app.kubernetes.io/name: {{ $queue.name }}
    role: {{ $role }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}
{{- end }}
{{- else if and (not .createPolicy) .attachToRoles }}
  {{- fail printf "Error: attachToRoles is set for queue %s but createPolicy is false. Set createPolicy: true to use attachToRoles." .name }}
{{- end }}

{{- end }}
{{- end }}

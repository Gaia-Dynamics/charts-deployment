{{- if and .Values.rds .Values.rds.clusters }}
{{- range .Values.rds.clusters }}
---
# Auto-generated password secret (if not provided)
{{- if not .masterUserPasswordSecretRef }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .name }}-password
  namespace: {{ $.Values.global.namespace | default "crossplane-system" }}
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
type: Opaque
data:
  # Generate random 32-character password using Helm's randAlphaNum
  # This will be generated once and persisted
  password: {{ randAlphaNum 32 | b64enc | quote }}

---
{{- end }}

{{- if not .vpcSecurityGroupIds }}
---
# Auto-created Security Group for RDS
apiVersion: ec2.aws.crossplane.io/v1beta1
kind: SecurityGroup
metadata:
  name: {{ .name }}-sg
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
spec:
  deletionPolicy: {{ .deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    region: {{ $.Values.global.region }}
    description: {{ printf "Security group for %s Aurora cluster" .name }}
    groupName: {{ .name }}-sg
    {{- if .vpcId }}
    vpcId: {{ .vpcId }}
    {{- else if eq $.Values.global.environment "qa" }}
    vpcId: vpc-0c6dffd97461de14f
    {{- else if eq $.Values.global.environment "prod" }}
    vpcId: vpc-0e43cfc91bc74be9e
    {{- else }}
      {{- fail "vpcId required when auto-creating security group or provide vpcSecurityGroupIds" }}
    {{- end }}
    tags:
      - key: Name
        value: {{ .name }}-sg
      - key: Environment
        value: {{ $.Values.global.environment }}
      - key: ManagedBy
        value: {{ $.Values.global.tags.managedBy | default "crossplane" }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}

---
# Security Group Rule - Allow PostgreSQL from app security group
apiVersion: ec2.aws.crossplane.io/v1beta1
kind: SecurityGroupRule
metadata:
  name: {{ .name }}-sg-rule-postgres
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
spec:
  deletionPolicy: {{ .deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    region: {{ $.Values.global.region }}
    type: ingress
    description: {{ printf "Allow PostgreSQL access to %s from application" .name }}
    fromPort: {{ .port | default 5432 }}
    toPort: {{ .port | default 5432 }}
    protocol: tcp
    securityGroupIdSelector:
      matchLabels:
        app.kubernetes.io/name: {{ .name }}
    {{- if eq $.Values.global.environment "qa" }}
    sourceSecurityGroupId: sg-023605daa63299b42  # QA app security group
    {{- else if eq $.Values.global.environment "prod" }}
    sourceSecurityGroupId: sg-004477da6d81e6cdf  # Prod app security group
    {{- else }}
      {{- fail "Unknown environment - cannot determine source security group" }}
    {{- end }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}

{{- end }}

---
# DB Subnet Group - Required for RDS in VPC
apiVersion: rds.aws.crossplane.io/v1alpha1
kind: DBSubnetGroup
metadata:
  name: {{ .name }}-subnet-group
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
spec:
  deletionPolicy: {{ .deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    region: {{ $.Values.global.region }}
    description: {{ printf "Subnet group for %s Aurora cluster" .name }}
    {{- if .subnetIds }}
    subnetIds:
    {{- range .subnetIds }}
      - {{ . }}
    {{- end }}
    {{- else if eq $.Values.global.environment "qa" }}
    subnetIds:
      - subnet-06b3bc451435c90c3
      - subnet-03c3b3c8377cb3f88
    {{- else if eq $.Values.global.environment "prod" }}
    subnetIds:
      - subnet-0bc4961ea0f8b699d
      - subnet-0e0efa4896e447362
    {{- else }}
      {{- fail "subnetIds is required for RDS cluster or use qa/prod environment" }}
    {{- end }}
    tags:
      - key: Name
        value: {{ .name }}-subnet-group
      - key: Environment
        value: {{ $.Values.global.environment }}
      - key: ManagedBy
        value: {{ $.Values.global.tags.managedBy | default "crossplane" }}
      - key: Department
        value: {{ $.Values.global.tags.department | default "engineering" }}
      - key: Service
        value: {{ $.Values.global.tags.service | default "gaia" }}
      {{- range $key, $value := .tags }}
      - key: {{ $key }}
        value: {{ $value | quote }}
      {{- end }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}

---
# DB Cluster Parameter Group
apiVersion: rds.aws.crossplane.io/v1alpha1
kind: DBClusterParameterGroup
metadata:
  name: {{ .name }}-cluster-params
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
spec:
  deletionPolicy: {{ .deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    region: {{ $.Values.global.region }}
    description: {{ printf "Cluster parameter group for %s" .name }}
    {{- if eq (.engine | default "aurora-postgresql") "aurora-postgresql" }}
    dbParameterGroupFamily: {{ .parameterGroupFamily | default "aurora-postgresql16" }}
    {{- else if eq .engine "aurora-mysql" }}
    dbParameterGroupFamily: {{ .parameterGroupFamily | default "aurora-mysql8.0" }}
    {{- else }}
    dbParameterGroupFamily: {{ .parameterGroupFamily }}
    {{- end }}
    {{- if .clusterParameters }}
    parameters:
    {{- range .clusterParameters }}
      - parameterName: {{ .name }}
        parameterValue: {{ .value | quote }}
        {{- if .applyMethod }}
        applyMethod: {{ .applyMethod }}
        {{- end }}
    {{- end }}
    {{- end }}
    tags:
      - key: Name
        value: {{ .name }}-cluster-params
      - key: Environment
        value: {{ $.Values.global.environment }}
      - key: ManagedBy
        value: {{ $.Values.global.tags.managedBy | default "crossplane" }}
      - key: Department
        value: {{ $.Values.global.tags.department | default "engineering" }}
      - key: Service
        value: {{ $.Values.global.tags.service | default "gaia" }}
      {{- range $key, $value := .tags }}
      - key: {{ $key }}
        value: {{ $value | quote }}
      {{- end }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}

---
# DB Parameter Group for instances
apiVersion: rds.aws.crossplane.io/v1alpha1
kind: DBParameterGroup
metadata:
  name: {{ .name }}-instance-params
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
spec:
  deletionPolicy: {{ .deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    region: {{ $.Values.global.region }}
    description: {{ printf "Instance parameter group for %s" .name }}
    {{- if eq (.engine | default "aurora-postgresql") "aurora-postgresql" }}
    dbParameterGroupFamily: {{ .parameterGroupFamily | default "aurora-postgresql16" }}
    {{- else if eq .engine "aurora-mysql" }}
    dbParameterGroupFamily: {{ .parameterGroupFamily | default "aurora-mysql8.0" }}
    {{- else }}
    dbParameterGroupFamily: {{ .parameterGroupFamily }}
    {{- end }}
    {{- if .instanceParameters }}
    parameters:
    {{- range .instanceParameters }}
      - parameterName: {{ .name }}
        parameterValue: {{ .value | quote }}
        {{- if .applyMethod }}
        applyMethod: {{ .applyMethod }}
        {{- end }}
    {{- end }}
    {{- end }}
    tags:
      - key: Name
        value: {{ .name }}-instance-params
      - key: Environment
        value: {{ $.Values.global.environment }}
      - key: ManagedBy
        value: {{ $.Values.global.tags.managedBy | default "crossplane" }}
      - key: Department
        value: {{ $.Values.global.tags.department | default "engineering" }}
      - key: Service
        value: {{ $.Values.global.tags.service | default "gaia" }}
      {{- range $key, $value := .tags }}
      - key: {{ $key }}
        value: {{ $value | quote }}
      {{- end }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}

---
# Aurora DB Cluster
apiVersion: rds.aws.crossplane.io/v1alpha1
kind: DBCluster
metadata:
  name: {{ .name }}
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
  annotations:
    crossplane.io/external-name: {{ .name }}
spec:
  deletionPolicy: {{ .deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    region: {{ $.Values.global.region }}

    # Engine configuration
    engine: {{ .engine | default "aurora-postgresql" }}
    {{- if eq (.engine | default "aurora-postgresql") "aurora-postgresql" }}
    engineVersion: {{ .engineVersion | default "16.4" }}
    {{- else if eq .engine "aurora-mysql" }}
    engineVersion: {{ .engineVersion | default "8.0.mysql_aurora.3.07.1" }}
    {{- else }}
    engineVersion: {{ .engineVersion }}
    {{- end }}
    engineMode: {{ .engineMode | default "provisioned" }}

    # Database configuration
    databaseName: {{ .databaseName | default "postgres" }}
    masterUsername: {{ .masterUsername | default "postgres" }}

    {{- if .masterUserPasswordSecretRef }}
    # Password from provided secret
    masterUserPasswordSecretRef:
      name: {{ .masterUserPasswordSecretRef.name }}
      namespace: {{ .masterUserPasswordSecretRef.namespace | default "crossplane-system" }}
      key: {{ .masterUserPasswordSecretRef.key | default "password" }}
    {{- else }}
    # Password from auto-generated secret
    masterUserPasswordSecretRef:
      name: {{ .name }}-password
      namespace: {{ $.Values.global.namespace | default "crossplane-system" }}
      key: password
    {{- end }}

    # Network configuration
    dbSubnetGroupName: {{ .name }}-subnet-group
    {{- if .vpcSecurityGroupIds }}
    vpcSecurityGroupIds:
    {{- range .vpcSecurityGroupIds }}
      - {{ . }}
    {{- end }}
    {{- else }}
    # Use auto-created security group
    vpcSecurityGroupIdSelector:
      matchLabels:
        app.kubernetes.io/name: {{ .name }}
    {{- end }}

    # Parameter groups
    dbClusterParameterGroupName: {{ .name }}-cluster-params

    # Backup configuration
    backupRetentionPeriod: {{ .backupRetentionPeriod | default 7 }}
    preferredBackupWindow: {{ .preferredBackupWindow | default "03:00-04:00" }}
    preferredMaintenanceWindow: {{ .preferredMaintenanceWindow | default "mon:04:00-mon:05:00" }}

    {{- if .skipFinalSnapshot }}
    skipFinalSnapshot: {{ .skipFinalSnapshot }}
    {{- else }}
    skipFinalSnapshot: false
    finalDBSnapshotIdentifier: {{ .name }}-final-snapshot
    {{- end }}

    # Storage encryption
    {{- if .kmsKeyId }}
    storageEncrypted: true
    kmsKeyId: {{ .kmsKeyId }}
    {{- else }}
    storageEncrypted: {{ .storageEncrypted | default true }}
    {{- end }}

    # Monitoring and logging
    {{- if .enableCloudwatchLogsExports }}
    enableCloudwatchLogsExports:
    {{- range .enableCloudwatchLogsExports }}
      - {{ . }}
    {{- end }}
    {{- else if eq (.engine | default "aurora-postgresql") "aurora-postgresql" }}
    enableCloudwatchLogsExports:
      - postgresql
    {{- end }}

    {{- if .enabledCloudwatchLogsExports }}
    enabledCloudwatchLogsExports:
    {{- range .enabledCloudwatchLogsExports }}
      - {{ . }}
    {{- end }}
    {{- end }}

    # Availability
    {{- if .availabilityZones }}
    availabilityZones:
    {{- range .availabilityZones }}
      - {{ . }}
    {{- end }}
    {{- end }}

    # Performance Insights
    {{- if .enablePerformanceInsights }}
    enablePerformanceInsights: {{ .enablePerformanceInsights }}
    {{- end }}

    # Deletion protection
    deletionProtection: {{ .deletionProtection | default false }}

    # Copy tags to snapshots
    copyTagsToSnapshot: {{ .copyTagsToSnapshot | default true }}

    # Serverless v2 scaling (if engineMode is provisioned and using serverless instances)
    {{- if .serverlessV2ScalingConfiguration }}
    serverlessV2ScalingConfiguration:
      minCapacity: {{ .serverlessV2ScalingConfiguration.minCapacity | default 0.5 }}
      maxCapacity: {{ .serverlessV2ScalingConfiguration.maxCapacity | default 1 }}
    {{- end }}

    # Tags
    tags:
      - key: Name
        value: {{ .name }}
      - key: Environment
        value: {{ $.Values.global.environment }}
      - key: ManagedBy
        value: {{ $.Values.global.tags.managedBy | default "crossplane" }}
      - key: Department
        value: {{ $.Values.global.tags.department | default "engineering" }}
      - key: Service
        value: {{ $.Values.global.tags.service | default "gaia" }}
      {{- range $key, $value := .tags }}
      - key: {{ $key }}
        value: {{ $value | quote }}
      {{- end }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}

{{- $cluster := . }}
{{- $instanceCount := .instanceCount | default 1 }}
{{- range $index := until (int $instanceCount) }}
---
# Aurora DB Instance {{ $index }}
apiVersion: rds.aws.crossplane.io/v1alpha1
kind: DBInstance
metadata:
  name: {{ $cluster.name }}-instance-{{ $index }}
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ $cluster.name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
    cluster: {{ $cluster.name }}
    instance-index: "{{ $index }}"
spec:
  deletionPolicy: {{ $cluster.deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    region: {{ $.Values.global.region }}

    # Cluster association
    dbClusterIdentifier: {{ $cluster.name }}

    # Engine
    engine: {{ $cluster.engine | default "aurora-postgresql" }}

    # Instance class
    {{- if $cluster.instanceClass }}
    dbInstanceClass: {{ $cluster.instanceClass }}
    {{- else if eq ($cluster.instanceType | default "provisioned") "serverless" }}
    dbInstanceClass: db.serverless
    {{- else }}
    dbInstanceClass: db.t4g.medium
    {{- end }}

    # Instance identifier
    dbInstanceIdentifier: {{ $cluster.name }}-instance-{{ $index }}

    # Parameter group
    dbParameterGroupName: {{ $cluster.name }}-instance-params

    # Public accessibility
    publiclyAccessible: {{ $cluster.publiclyAccessible | default false }}

    # Monitoring
    {{- if $cluster.monitoringInterval }}
    monitoringInterval: {{ $cluster.monitoringInterval }}
    {{- if $cluster.monitoringRoleArn }}
    monitoringRoleArn: {{ $cluster.monitoringRoleArn }}
    {{- end }}
    {{- end }}

    # Performance Insights
    {{- if $cluster.enablePerformanceInsights }}
    enablePerformanceInsights: {{ $cluster.enablePerformanceInsights }}
    {{- if $cluster.performanceInsightsKmsKeyId }}
    performanceInsightsKmsKeyId: {{ $cluster.performanceInsightsKmsKeyId }}
    {{- end }}
    {{- if $cluster.performanceInsightsRetentionPeriod }}
    performanceInsightsRetentionPeriod: {{ $cluster.performanceInsightsRetentionPeriod }}
    {{- end }}
    {{- end }}

    # Auto minor version upgrade
    autoMinorVersionUpgrade: {{ $cluster.autoMinorVersionUpgrade | default true }}

    # Preferred maintenance window
    preferredMaintenanceWindow: {{ $cluster.preferredMaintenanceWindow | default "mon:04:00-mon:05:00" }}

    # Promotion tier (for failover priority)
    promotionTier: {{ $index }}

    # Availability zone (optional, let AWS choose if not specified)
    {{- if $cluster.availabilityZones }}
    {{- if lt $index (len $cluster.availabilityZones) }}
    availabilityZone: {{ index $cluster.availabilityZones $index }}
    {{- end }}
    {{- end }}

    # Tags
    tags:
      - key: Name
        value: {{ $cluster.name }}-instance-{{ $index }}
      - key: Environment
        value: {{ $.Values.global.environment }}
      - key: ManagedBy
        value: {{ $.Values.global.tags.managedBy | default "crossplane" }}
      - key: Department
        value: {{ $.Values.global.tags.department | default "engineering" }}
      - key: Service
        value: {{ $.Values.global.tags.service | default "gaia" }}
      - key: Cluster
        value: {{ $cluster.name }}
      - key: InstanceIndex
        value: "{{ $index }}"
      {{- range $key, $value := $cluster.tags }}
      - key: {{ $key }}
        value: {{ $value | quote }}
      {{- end }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}
{{- end }}

{{- if .createSecret }}
---
# Kubernetes Secret to store connection details
apiVersion: v1
kind: Secret
metadata:
  name: {{ .name }}-connection
  namespace: {{ .secretNamespace | default "default" }}
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
type: Opaque
stringData:
  host: {{ .name }}.cluster-{{ .customClusterSuffix | default "changeme" }}.{{ $.Values.global.region }}.rds.amazonaws.com
  port: "{{ .port | default 5432 }}"
  database: {{ .databaseName | default "postgres" }}
  username: {{ .masterUsername | default "postgres" }}
  # Note: Password should be retrieved from the secret specified in masterUserPasswordSecretRef
  {{- if eq (.engine | default "aurora-postgresql") "aurora-postgresql" }}
  engine: "postgresql"
  {{- else if eq .engine "aurora-mysql" }}
  engine: "mysql"
  {{- end }}
{{- end }}

{{- if .createPolicy }}
---
# IAM Policy for RDS access
apiVersion: iam.aws.crossplane.io/v1beta1
kind: Policy
metadata:
  name: {{ .name }}-rds-policy
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ .name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
spec:
  deletionPolicy: {{ .deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    name: {{ .name }}-rds-policy
    description: {{ printf "Policy for RDS cluster %s managed by Crossplane" .name }}
    document: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "RDSConnect",
            "Effect": "Allow",
            "Action": [
              "rds-db:connect"
            ],
            "Resource": "arn:aws:rds-db:{{ $.Values.global.region }}:{{ $.Values.global.accountId }}:dbuser:*/*"
          },
          {
            "Sid": "RDSDescribe",
            "Effect": "Allow",
            "Action": [
              "rds:DescribeDBClusters",
              "rds:DescribeDBInstances"
            ],
            "Resource": [
              "arn:aws:rds:{{ $.Values.global.region }}:{{ $.Values.global.accountId }}:cluster:{{ .name }}",
              "arn:aws:rds:{{ $.Values.global.region }}:{{ $.Values.global.accountId }}:db:{{ .name }}-*"
            ]
          }
          {{- if .kmsKeyId }},
          {
            "Sid": "KMSAccess",
            "Effect": "Allow",
            "Action": [
              "kms:Decrypt",
              "kms:DescribeKey"
            ],
            "Resource": "{{ .kmsKeyId }}"
          }
          {{- end }}
        ]
      }
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}
{{- end }}

{{- if and .createPolicy .attachToRoles }}
{{- $cluster := . }}
{{- range $index, $role := .attachToRoles }}
---
apiVersion: iam.aws.crossplane.io/v1beta1
kind: RolePolicyAttachment
metadata:
  name: {{ $cluster.name }}-role-attachment-{{ $index }}
  labels:
    helm.sh/chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    app.kubernetes.io/name: {{ $cluster.name }}
    app.kubernetes.io/managed-by: crossplane
    environment: {{ $.Values.global.environment }}
    purpose: irsa-attachment
spec:
  deletionPolicy: {{ $cluster.deletionPolicy | default $.Values.global.deletionPolicy }}
  forProvider:
    policyArn: arn:aws:iam::{{ $.Values.global.accountId }}:policy/{{ $cluster.name }}-rds-policy
    roleName: {{ $role }}
  providerConfigRef:
    name: {{ $.Values.global.providerConfig }}
{{- end }}
{{- else if and (not .createPolicy) .attachToRoles }}
  {{- fail printf "Error: attachToRoles is set for cluster %s but createPolicy is false. Set createPolicy: true to use attachToRoles." .name }}
{{- end }}

{{- end }}
{{- end }}
